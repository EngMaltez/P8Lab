pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
--protect the circle
--by miguel maltez

--todo:
--. collision detection wave and rock
--. collision detection rock and player
--. delete rocks when out of range

function _init()
	init_game()
end

-->8
-- game

function init_game()
	plr = {x=63,y=63,r=5} -- player
	waves={}      -- shockwaves
	rocks={}      -- rocks
	_update = update_game
	_draw = draw_game
end

function update_game()
	if (btn(‚¨ÖÔ∏è)) plr.x -=1
	if (btn(‚û°Ô∏è)) plr.x +=1
	if (btn(‚¨ÜÔ∏è)) plr.y -=1
	if (btn(‚¨áÔ∏è)) plr.y +=1
	
	if btnp(üÖæÔ∏è) then
		sfx(1)
	 create_shockwave()
	end
	if btnp(‚ùé) then
		sfx(2)
		create_rock()
	end

	update_shockwaves()
	update_rocks()
	-- check collisions waves & rocks
	for wave in all(waves) do
		for rock in all(rocks) do
			if is_colliding(wave,rock) then
				sfx(3)
				del(rocks, rock)
			end
		end
	end
	-- rocks collided with player
	for rock in all(rocks) do
		if is_colliding(rock,plr) then
			sfx(4)
			del(rocks, rock)
			init_gameover(rock)
		elseif dist(rock,plr) > 256 then
			del(rocks, rock)
		end
	end
end

function draw_game()
	cls()
	circ(plr.x,plr.y,plr.r,4)
	draw_shockwaves()
	draw_rocks()
	print("waves:"..#waves,0,0,12)
end

-->8
-- menu

-->8
-- shockwave

function create_shockwave()
	add(waves,
		{x=plr.x, y=plr.y, r=plr.r}
	)
end

function update_shockwaves()
	for wave in all(waves) do
		wave.r += 0.2
		if wave.r > 60 then
			del(waves,wave)
		end
	end
end

function draw_shockwaves()
	for wave in all(waves) do
		circ(wave.x,wave.y,wave.r,13)
	end
end

-->8
-- rocks

function create_rock()
	local angle = rnd(1)
	rock = {
		x = 91*cos(angle) + plr.x,
		y = 91*sin(angle) + plr.y,
		r = flr(rnd(2))+1,
		vx=0, vy=0
	}
	local dx = plr.x-rock.x
	local dy = plr.y-rock.y
	local distance = dist(plr,rock)
	rock.vx = dx / distance
	rock.vy = dy / distance
	add(rocks,rock)
	lastrock = rock
end

function update_rocks()
	for rock in all(rocks) do
		rock.x += rock.vx
		rock.y += rock.vy
	end
end

function draw_rocks()
	for rock in all(rocks) do
		circ(rock.x,rock.y,rock.r,5)
	end
	if lastrock then
		print("("..lastrock.x..","..lastrock.y..")", 64,6,5)
	end
	print("rocks:"..#rocks,0,6,5)
end

-->8
-- collision

function dist(o1,o2)
	local dx = (o1.x - o2.x)/4
	local dy = (o1.y - o2.y)/4
	return 4*sqrt(dx*dx+dy*dy)
end

function is_colliding(o1, o2)
	-- collision between 2 circles
	return dist(o1,o2) < (o1.r + o2.r)
end
 

-->8
-- game over

function init_gameover(rock)
	lastrock = rock
	_update = update_gameover
	_draw = draw_gameover
end

function update_gameover()
	if (btn(‚ùé)) init_game()
end

function draw_gameover()
	cls(8)
	print("game over",40,60,1)
	print("("..lastrock.x ..","..lastrock.y..")")
	dx = plr.x - lastrock.x
	dy = plr.y - lastrock.y
	print(dx*dx+dy*dy)
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020000080501e0502b050350503a050390502d0501e05018050130500f0500d0500a05009050080500705007050060500605005050050500305003050010500005000050000000000000000000000000000000
00100000040500b050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000500002963020640136200b61005610036100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001400001d5501b55007550045500155000500025001060007600086000660003600026000160000600296002e600006000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0016000013700177001a7001e5002150023500137000f1001d0002000023000197001c7001f7001c700037000b7000c70008700087000570002700007000070000700007000070015700007001e000220001e700
__music__
00 41424344
00 0b424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 41424344
00 4b424344

